<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<script>
    // üö® ENSURE THIS MATCHES YOUR DEPLOYED WORKER URL
    const SECURE_DATA_URL = 'https://carbon-data-worker.metacarbonics.workers.dev/'; 
    
    var map = L.map('map').setView([20, 0], 2);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap &copy; CARTO',
        maxZoom: 19
    }).addTo(map);

    var markers = L.layerGroup().addTo(map);
    var table;

    async function fetchSecureProjects() {
        try {
            $('#fetch-status').text('Connecting...').css('color', '#ffc107'); 

            const response = await fetch(SECURE_DATA_URL);
            if (!response.ok) throw new Error(`Worker Error: ${response.status}`);

            const csvText = await response.text();

            // --- CSV PARSING LOGIC ---
            Papa.parse(csvText, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    const rows = results.data;
                    $('#loading').hide();
                    $('#projectTable').show();
                    
                    processAndRenderData(rows);
                    $('#fetch-status').text('Success').css('color', 'var(--stat-green)');
                },
                error: function(err) {
                    throw new Error("CSV Parsing Failed");
                }
            });

        } catch (error) {
            console.error("Error:", error);
            $('#loading').html(`‚ùå Error: Data fetch failed. <small>${error.message}</small>`).css('color', 'red');
            $('#fetch-status').text('Failed').css('color', 'red');
        }
    }
    
    function processAndRenderData(rows) {
        let tableData = [];
        
        // Update Stats
        $('#project-count').text(rows.length);
        $('#update-date').text(new Date().toLocaleDateString()); // Shows today since it's a live fetch

        rows.forEach(project => {
            // Extract Coordinates from CSV columns
            const lat = parseFloat(project.Latitude);
            const lng = parseFloat(project.Longitude);

            if (!isNaN(lat) && !isNaN(lng)) {
                // a) Add to Map
                addProjectMarker(lat, lng, project);
                
                // b) Add to Table Array
                tableData.push([
                    project.ID || 'N/A',
                    project['Project Name'] || 'Unnamed',
                    project.Country || 'N/A',
                    project.Status || 'N/A',
                    'VCS',
                    `<a href="${project['Registry Link'] || '#'}" target="_blank">View</a>`
                ]);
            }
        });
        
        renderTable(tableData);
        
        if (markers.getLayers().length > 0) {
            map.fitBounds(markers.getBounds());
        }
    }
    
    function addProjectMarker(lat, lng, project) {
        const markerColor = (project.Status && project.Status.toLowerCase() === 'registered') ? 'var(--stat-green)' : '#ffc107'; 

        const marker = L.circleMarker([lat, lng], {
            radius: 6,
            fillColor: markerColor,
            color: "#000",
            weight: 1,
            fillOpacity: 0.8
        });
        
        const popupContent = `
            <b>${project['Project Name']}</b><br>
            ID: ${project.ID}<br>
            Status: ${(project.Status || 'N/A').toUpperCase()}<br>
            Country: ${project.Country}
        `;
        
        marker.bindPopup(popupContent);
        markers.addLayer(marker);
    }

    function renderTable(data) {
        if ($.fn.DataTable.isDataTable('#projectTable')) {
            $('#projectTable').DataTable().destroy();
        }
        table = $('#projectTable').DataTable({
            data: data,
            paging: true,
            pageLength: 5,
            lengthMenu: [5, 10, 25, 50],
            ordering: true,
            searching: true,
        });
    }
    
    $(document).ready(function() {
        fetchSecureProjects();
    });
</script>